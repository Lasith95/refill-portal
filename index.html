<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refill Reserve | Professional Staff Portal</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Refill">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --bg-body: #0f1113;
            --bg-card: #1c1f22;
            --accent: #d4af37;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --error: #e74c3c;
            --success: #2ecc71;
            /* Categories */
            --c-signature: #800000;
            --c-espresso: #6f4e37;
            --c-milk: #e67e22;
            --c-matcha: #2ecc71;
            --c-fruit: #d35400;
            --c-manual: #3498db;
            --c-batch: #7f8c8d;
            --c-tea: #34495e;
            --c-frappe: #964b00;
            --c-mojito: #1abc9c;
            --c-na: #607d8b;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0; padding: 20px;
            line-height: 1.6;
        }

        /* Authentication Overlay */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: var(--bg-card); padding: 50px; border-radius: 4px;
            border: 1px solid var(--accent); text-align: center; width: 350px;
        }
        #passInput {
            padding: 12px; border-radius: 4px; border: 1px solid #444;
            background: #252a2e; color: white; width: 100%; margin-bottom: 20px; text-align: center;
        }

        /* Layout */
        #main-content { display: none; width: 100%; max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; letter-spacing: 8px; color: var(--accent); text-transform: uppercase; margin: 0 0 25px 0; }

        /* Unified Buttons */
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn {
            background: transparent; border: 1px solid #444; color: var(--text-secondary);
            padding: 12px 25px; border-radius: 4px; cursor: pointer; transition: 0.3s;
            font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
        }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .tab-btn:hover:not(.active) { border-color: var(--accent); color: var(--accent); }

        /* Category Filter Navigation */
        .category-nav {
            display: flex; justify-content: center; flex-wrap: wrap; 
            gap: 10px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #333;
        }
        .cat-filter-btn {
            background: #1c1f22; border: 1px solid #333; color: var(--text-secondary);
            padding: 8px 16px; border-radius: 2px; cursor: pointer; font-size: 0.7rem;
            text-transform: uppercase; transition: 0.2s; font-weight: bold;
        }
        .cat-filter-btn.active { border-color: var(--accent); color: var(--accent); background: #252a2e; }

        .search-container { text-align: center; margin-bottom: 30px; }
        .search-bar {
            width: 100%; max-width: 500px; padding: 14px 25px;
            background: #1c1f22; border: 1px solid #333; border-radius: 4px;
            color: white; outline: none; border-bottom: 2px solid var(--accent); font-size: 1rem;
        }

        /* Card Display */
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .card { height: 500px; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 4px; padding: 30px; }
        
        .card-front { 
            background: var(--bg-card); border: 1px solid #333; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; 
        }
        .card-back { background: #ffffff; color: #1a1a1a; transform: rotateY(180deg); overflow-y: auto; }
        
        .cat-tag { font-size: 0.65rem; padding: 4px 12px; color: white; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-radius: 2px; }
        .label { display: block; font-weight: 800; font-size: 0.65rem; color: #888; text-transform: uppercase; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .content { font-size: 0.95rem; color: #333; padding-top: 5px; font-weight: 400; }

        /* Calibration Specific Tool */
        .dial-step { margin-bottom: 20px; }
        .dial-step label { display: block; font-size: 0.7rem; color: var(--accent); text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }

        #calc-section, #dial-section { display: none; max-width: 800px; margin: 0 auto; }
        .calc-box { background: var(--bg-card); padding: 40px; border-radius: 4px; border: 1px solid #333; text-align: center; }
        .calc-input {
            width: 100%; padding: 15px; background: #252a2e; border: 1px solid #444;
            color: white; font-size: 1.2rem; text-align: center; border-radius: 4px; margin-bottom: 10px;
        }
        select.calc-input { font-size: 1rem; appearance: auto; }
        .yield-display {
            margin-top: 30px; padding: 20px; background: #15181a; border-radius: 4px; border: 1px dashed var(--accent);
        }
        .yield-value { font-size: 2.5rem; color: var(--accent); font-weight: bold; display: block; }

        @media (max-width: 600px) { 
            h1 { font-size: 1.4rem; }
            .nav-tabs { flex-direction: column; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--accent); letter-spacing: 4px; text-transform: uppercase; margin-bottom: 25px;">Refill Access</h2>
        <input type="password" id="passInput" placeholder="Enter Password">
        <button class="tab-btn active" style="width: 100%;" onclick="checkAuth()">Enter Dashboard</button>
        <p id="loadingStatus" style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 15px;">Loading Live Data...</p>
    </div>
</div>

<div id="main-content">
    <header><h1>Refill Reserve</h1></header>

    <div class="nav-tabs">
        <button class="tab-btn active" id="btn-browse" onclick="showTab('browse')">Recipe Cards</button>
        <button class="tab-btn" id="btn-calc" onclick="showTab('calc')">Yield Calculator</button>
        <button class="tab-btn" id="btn-dial" onclick="showTab('dial')">Espresso Calibration</button>
        <button class="tab-btn" id="btn-contact" onclick="showTab('contact')">Contact Details</button>
        <button class="tab-btn" id="btn-docs" onclick="showTab('documents')">Documents</button>
    </div>

    <div id="browse-section">
        <div class="category-nav">
            <button class="cat-filter-btn active" onclick="filterCat('All', this)">All</button>
            <button class="cat-filter-btn" onclick="filterCat('Signature', this)">Signature</button>
            <button class="cat-filter-btn" onclick="filterCat('Espresso Based', this)">Espresso</button>
            <button class="cat-filter-btn" onclick="filterCat('Milk Based', this)">Milk Based</button>
            <button class="cat-filter-btn" onclick="filterCat('Frappe', this)">Frappe</button>
            <button class="cat-filter-btn" onclick="filterCat('NA', this)">NA</button>
            <button class="cat-filter-btn" onclick="filterCat('Mojito', this)">Mojito</button>
            <button class="cat-filter-btn" onclick="filterCat('Matcha', this)">Matcha</button>
            <button class="cat-filter-btn" onclick="filterCat('Fruit & Smoothies', this)">Fruit & Smoothies</button>
            <button class="cat-filter-btn" onclick="filterCat('Pour Over', this)">Pour Over</button>
            <button class="cat-filter-btn" onclick="filterCat('Batch', this)">Batch</button>
            <button class="cat-filter-btn" onclick="filterCat('Tea', this)">Tea</button>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-bar" placeholder="Search by drink name..." onkeyup="renderCards()">
        </div>
        <div class="recipe-grid" id="recipeGrid"></div>
    </div>

    <div id="calc-section">
        <div class="calc-box">
            <h2 style="color:var(--accent); text-transform:uppercase; letter-spacing:2px; margin-bottom:30px;">Yield Calculator</h2>
            <div class="category-nav" style="border:none;">
                <button class="cat-filter-btn active" onclick="setCalcDevice('Espresso', 2, this)">Espresso (1:2)</button>
                <button class="cat-filter-btn" onclick="setCalcDevice('V60', 15, this)">V60 (1:15)</button>
                <button class="cat-filter-btn" onclick="setCalcDevice('Chemex', 15, this)">Chemex (1:15)</button>
                <button class="cat-filter-btn" onclick="setCalcDevice('Aeropress', 10, this)">Aeropress (1:10)</button>
            </div>
            <input type="number" id="calcDose" class="calc-input" placeholder="Enter Dose (g)" oninput="calculateYield()">
            <div class="yield-display">
                <span class="label">Target Yield (Output)</span>
                <span class="yield-value"><span id="yieldResult">0</span>g</span>
            </div>
        </div>
    </div>

    <div id="dial-section">
        <div class="calc-box" style="text-align: left;">
            <h2 style="color:var(--accent); text-transform:uppercase; text-align:center; letter-spacing: 2px;">Espresso Diagnostic</h2>
            
            <div class="dial-step">
                <label>1. Time Check (Target: 25-32s)</label>
                <select id="dialTime" class="calc-input">
                    <option value="good">On Time (25-32s)</option>
                    <option value="fast">Too Fast (< 25s)</option>
                    <option value="slow">Too Slow (> 32s)</option>
                </select>
            </div>

            <div class="dial-step">
                <label>2. Taste Primary Symptom</label>
                <select id="dialTaste" class="calc-input">
                    <option value="balanced">Balanced / Sweet</option>
                    <option value="sour">Sour / Salty / Sharp</option>
                    <option value="bitter">Bitter / Dry / Astringent</option>
                    <option value="weak">Thin / Weak Body</option>
                </select>
            </div>

            <button class="tab-btn active" style="width: 100%; margin-top: 10px;" onclick="runCalibration()">Get Adjustment</button>

            <div id="dialResult" class="yield-display" style="display:none; text-align:left;">
                <span class="label">Required Adjustment:</span>
                <div id="dialMessage" class="content" style="color: white; font-size: 1.1rem; padding-top:10px;"></div>
            </div>
        </div>
    </div>

    <div id="contact-section" style="display:none;">
        <div style="text-align:center; margin-bottom:20px;">
            <a href="https://chat.whatsapp.com/PASTE_YOUR_LINK_HERE" class="tab-btn active" style="display:inline-block; background:var(--error); color:white; border:none;">Message All Staff</a>
        </div>
        <div class="recipe-grid" id="contactGrid"></div>
    </div>

    <div id="documents-section" style="display:none;">
        <div class="recipe-grid" id="docsGrid"></div>
    </div>
</div>

<script>
const MASTER_PASS = "Refill2024";
let activeCat = "All";
let currentRatio = 2;

const CONFIG = {
    recipes: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ13wVqduebIg7mNo0ppS0BGucdTT8rviaMw6-FZcATLyJ11aBE8809JXrTzzQlsjAPuyJTy0R1H9qg/pub?gid=0&single=true&output=csv",
    contacts: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ13wVqduebIg7mNo0ppS0BGucdTT8rviaMw6-FZcATLyJ11aBE8809JXrTzzQlsjAPuyJTy0R1H9qg/pub?gid=868158229&single=true&output=csv",
    docs: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ13wVqduebIg7mNo0ppS0BGucdTT8rviaMw6-FZcATLyJ11aBE8809JXrTzzQlsjAPuyJTy0R1H9qg/pub?gid=1810968270&single=true&output=csv"
};

let data = [], contactData = [], docData = [];

window.onload = function() {
    let filesLoaded = 0;
    const checkStatus = () => { if(++filesLoaded === 3) document.getElementById('loadingStatus').innerText = "Ready."; };

    Papa.parse(CONFIG.recipes, { download: true, header: true, complete: r => { data = r.data; checkStatus(); } });
    Papa.parse(CONFIG.contacts, { download: true, header: true, complete: r => { contactData = r.data; checkStatus(); } });
    Papa.parse(CONFIG.docs, { download: true, header: true, complete: r => { docData = r.data; checkStatus(); } });
};

function checkAuth() {
    if(document.getElementById('passInput').value === MASTER_PASS) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        renderCards();
    }
}

function showTab(view) {
    document.getElementById('browse-section').style.display = (view === 'browse') ? 'block' : 'none';
    document.getElementById('calc-section').style.display = (view === 'calc') ? 'block' : 'none';
    document.getElementById('dial-section').style.display = (view === 'dial') ? 'block' : 'none';
    document.getElementById('contact-section').style.display = (view === 'contact') ? 'block' : 'none';
    document.getElementById('documents-section').style.display = (view === 'documents') ? 'block' : 'none';
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('btn-' + view).classList.add('active');
    
    if(view === 'contact') renderContacts();
    if(view === 'documents') renderDocuments();
}

function renderCards() {
    const grid = document.getElementById('recipeGrid');
    grid.innerHTML = '';
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    data.forEach(item => {
        const itemName = item.name || item.Name || '';
        const itemCat = item.cat || item.Category || '';
        const itemColor = item.color || item.Color || 'var(--accent)';
        const itemIng = item.ing || item.Ingredients || item.ingredients || '';
        const itemMethod = item.method || item.Method || '';
        const itemEq = item.eq || item.Equipment || item.equipment || '';
        const itemServ = item.serv || item.Serving || item.serving || '';

        if(activeCat !== 'All' && itemCat !== activeCat) return;
        if(search && !itemName.toLowerCase().includes(search)) return;
        
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = function() { this.classList.toggle('flipped'); };
        card.innerHTML = `
            <div class="card-inner">
                <div class="card-front">
                    <span class="cat-tag" style="background: ${itemColor}">${itemCat}</span>
                    <h2 style="margin: 10px 0;">${itemName}</h2>
                </div>
                <div class="card-back">
                    <h3 style="margin-top:0; color: #000;">${itemName}</h3>
                    <span class="label">Ingredients</span><div class="content">${itemIng}</div>
                    <span class="label">Method</span><div class="content">${itemMethod}</div>
                    <span class="label">Equipment</span><div class="content">${itemEq}</div>
                    <span class="label">Serving</span><div class="content">${itemServ}</div>
                </div>
            </div>`;
        grid.appendChild(card);
    });
}

function renderContacts() {
    const grid = document.getElementById('contactGrid');
    grid.innerHTML = '';
    contactData.forEach(item => {
        const cName = item.name || item.Name || '';
        const cRole = item.role || item.Role || '';
        const cPhone = item.phone || item.Phone || '';
        const cleanPhone = cPhone.replace(/\D/g, '');

        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = function() { this.classList.toggle('flipped'); };
        card.innerHTML = `
            <div class="card-inner">
                <div class="card-front">
                    <span class="cat-tag" style="background: var(--accent)">Contact</span>
                    <h2>${cName}</h2>
                    <p>${cRole}</p>
                </div>
                <div class="card-back">
                    <h3 style="color:black;">${cName}</h3>
                    <span class="label">Role</span><div class="content">${cRole}</div>
                    <span class="label">Phone</span><div class="content">${cPhone}</div>
                    <div style="margin-top:20px;">
                        <a href="tel:${cPhone}" class="tab-btn active" style="display:block; text-align:center; margin-bottom:10px;">Call Now</a>
                        <a href="https://wa.me/${cleanPhone}" target="_blank" class="tab-btn active" style="display:block; text-align:center; background:#25D366; border-color:#25D366;">WhatsApp</a>
                    </div>
                </div>
            </div>`;
        grid.appendChild(card);
    });
}

function renderDocuments() {
    const grid = document.getElementById('docsGrid');
    grid.innerHTML = '';
    docData.forEach(item => {
        const dName = item.name || item.Name || '';
        const dFile = item.file || item.File || item.Link || '';
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = function() { this.classList.toggle('flipped'); };
        card.innerHTML = `
            <div class="card-inner">
                <div class="card-front">
                    <span class="cat-tag" style="background: var(--error)">DOC</span>
                    <h2>${dName}</h2>
                </div>
                <div class="card-back">
                    <h3>${dName}</h3>
                    <a href="${dFile}" target="_blank" class="tab-btn active" style="display:block; text-align:center; margin-top:50px;">Open File</a>
                </div>
            </div>`;
        grid.appendChild(card);
    });
}

function filterCat(cat, btn) {
    activeCat = cat;
    document.querySelectorAll('.cat-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderCards();
}

function calculateYield() {
    const dose = document.getElementById('calcDose').value;
    document.getElementById('yieldResult').innerText = dose > 0 ? (dose * currentRatio).toFixed(1) : "0";
}

function setCalcDevice(device, ratio, btn) {
    currentRatio = ratio;
    btn.parentElement.querySelectorAll('.cat-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    calculateYield();
}

// UPDATED CALIBRATION LOGIC
function runCalibration() {
    const time = document.getElementById('dialTime').value;
    const taste = document.getElementById('dialTaste').value;
    const res = document.getElementById('dialResult');
    const msg = document.getElementById('dialMessage');
    
    res.style.display = 'block';
    
    if (time === 'fast') {
        msg.innerHTML = "<strong>GRIND FINER.</strong> Your shot is flowing too quickly. Adjust collar to a smaller number.";
    } else if (time === 'slow') {
        msg.innerHTML = "<strong>GRIND COARSER.</strong> Your shot is choking or too slow. Adjust collar to a larger number.";
    } else {
        // Time is good, check taste
        if (taste === 'sour') {
            msg.innerHTML = "<strong>INCREASE YIELD.</strong> Time is good, but it's under-extracted. Try a slightly longer output (e.g. +2g yield).";
        } else if (taste === 'bitter') {
            msg.innerHTML = "<strong>DECREASE YIELD.</strong> Time is good, but it's over-extracted. Try a slightly shorter output (e.g. -2g yield).";
        } else if (taste === 'weak') {
            msg.innerHTML = "<strong>INCREASE DOSE.</strong> Ensure your basket is full and tamp is level.";
        } else {
            msg.innerHTML = "<span style='color:var(--success)'><strong>PERFECT SHOT.</strong> No adjustments needed. Well done.</span>";
        }
    }
}
</script>
</body>
</html>