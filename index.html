<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refill Reserve | Professional Staff Portal</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Refill">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg-body: #0f1113;
            --bg-card: #1c1f22;
            --accent: #d4af37;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --error: #e74c3c;
            /* Categories */
            --c-signature: #800000;
            --c-espresso: #6f4e37;
            --c-milk: #e67e22;
            --c-matcha: #2ecc71;
            --c-fruit: #d35400;
            --c-manual: #3498db;
            --c-batch: #7f8c8d;
            --c-tea: #34495e;
            --c-frappe: #964b00;
            --c-mojito: #1abc9c;
            --c-na: #607d8b;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0; padding: 20px;
            line-height: 1.6;
        }

        /* Authentication Overlay */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: var(--bg-card);
            padding: 50px; border-radius: 4px;
            border: 1px solid var(--accent); text-align: center; width: 350px;
        }
        #passInput {
            padding: 12px;
            border-radius: 4px; border: 1px solid #444;
            background: #252a2e; color: white; width: 100%; margin-bottom: 20px; text-align: center;
        }

        /* Layout */
        #main-content { display: none;
            width: 100%; max-width: 1400px; margin: 0 auto; }
        header { text-align: center;
            margin-bottom: 30px; }
        h1 { font-size: 1.8rem; letter-spacing: 8px; color: var(--accent); text-transform: uppercase;
            margin: 0 0 25px 0; }

        /* Unified Buttons */
        .nav-tabs { display: flex;
            justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn {
            background: transparent;
            border: 1px solid #444; color: var(--text-secondary);
            padding: 12px 25px; border-radius: 4px; cursor: pointer; transition: 0.3s;
            font-weight: 600; text-transform: uppercase;
            font-size: 0.8rem; letter-spacing: 1px;
        }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent);
        }
        .tab-btn:hover:not(.active) { border-color: var(--accent); color: var(--accent);
        }

        /* Category Filter Navigation */
        .category-nav {
            display: flex;
            justify-content: center; flex-wrap: wrap; 
            gap: 10px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #333;
        }
        .cat-filter-btn {
            background: #1c1f22;
            border: 1px solid #333; color: var(--text-secondary);
            padding: 8px 16px; border-radius: 2px; cursor: pointer; font-size: 0.7rem;
            text-transform: uppercase; transition: 0.2s;
            font-weight: bold;
        }
        .cat-filter-btn.active { border-color: var(--accent); color: var(--accent); background: #252a2e;
        }

        .search-container { text-align: center; margin-bottom: 30px;
        }
        .search-bar {
            width: 100%;
            max-width: 500px; padding: 14px 25px;
            background: #1c1f22; border: 1px solid #333; border-radius: 4px;
            color: white; outline: none;
            border-bottom: 2px solid var(--accent); font-size: 1rem;
        }

        /* Card Display */
        .recipe-grid { display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .card { height: 500px; perspective: 1000px;
            cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%;
            transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg);
        }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 4px; padding: 30px; }
        
        .card-front { 
            background: var(--bg-card);
            border: 1px solid #333; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .card-back { background: #ffffff; color: #1a1a1a; transform: rotateY(180deg); overflow-y: auto;
        }
        
        .cat-tag { font-size: 0.65rem;
            padding: 4px 12px; color: white; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-radius: 2px; }
        .label { display: block; font-weight: 800; font-size: 0.65rem; color: #888; text-transform: uppercase;
            margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .content { font-size: 0.95rem;
            color: #333; padding-top: 5px; font-weight: 400; }

        /* Quiz Layout */
        #quiz-section { display: none;
            max-width: 900px; margin: 0 auto; }
        .quiz-box { background: var(--bg-card); padding: 50px;
            border-radius: 4px; border: 1px solid #333; text-align: center; }
        .question-text { font-size: 1.6rem;
            margin: 25px 0; color: #fff; font-weight: 300; }
        .options-grid { display: grid;
            grid-template-columns: 1fr; gap: 15px; }
        .option-btn { 
            background: #15181a;
            border: 1px solid #333; color: white; padding: 20px; 
            border-radius: 4px; cursor: pointer; text-align: left; font-size: 0.95rem; transition: 0.2s;
        }
        .option-btn:hover { border-color: var(--accent); background: #1c1f22;
        }

        /* Tools Sections */
        #calc-section, #dial-section, #trouble-section { display: none;
            max-width: 800px; margin: 0 auto; }
        .calc-box { background: var(--bg-card); padding: 40px;
            border-radius: 4px; border: 1px solid #333; text-align: center; }
        .calc-input {
            width: 100%;
            padding: 15px; background: #252a2e; border: 1px solid #444;
            color: white; font-size: 1.2rem; text-align: center; border-radius: 4px; margin: 20px 0;
        }
        select.calc-input { font-size: 1rem; appearance: auto;
        }
        .yield-display {
            margin-top: 30px;
            padding: 20px; background: #15181a; border-radius: 4px; border: 1px dashed var(--accent);
        }
        .yield-value { font-size: 2.5rem; color: var(--accent); font-weight: bold; display: block;
        }

        /* Popup Overlay */
        #popup-overlay { 
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center;
        }
        .popup-box { background: #fff; color: #000; padding: 40px; border-radius: 4px; max-width: 600px;
            width: 90%; }

        /* PDF Viewer Overlay */
        #pdf-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000; flex-direction: column;
        }
        .pdf-header {
            padding: 15px;
            background: #1c1f22; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 1px solid var(--accent);
        }
        
        @media (max-width: 600px) { 
            h1 { font-size: 1.4rem;
            }
            .nav-tabs { flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--accent); letter-spacing: 4px; text-transform: uppercase; margin-bottom: 25px;">Refill Access</h2>
        <input type="password" id="passInput" placeholder="Enter Password">
        <button class="tab-btn active" style="width: 100%;" onclick="checkAuth()">Enter Dashboard</button>
    </div>
</div>

<div id="main-content">
    <header><h1>Refill Reserve</h1></header>

    <div class="nav-tabs">
        <button class="tab-btn active" id="btn-browse" onclick="showTab('browse')">Recipe Cards</button>
        <button class="tab-btn" id="btn-quiz" onclick="showTab('quiz')">Staff Quiz</button>
        <button class="tab-btn" id="btn-calc" onclick="showTab('calc')">Yield Calculator</button>
        <button class="tab-btn" id="btn-dial" onclick="showTab('dial')">Espresso Calibration</button>
        <button class="tab-btn" id="btn-trouble" onclick="showTab('trouble')">Troubleshooting</button>
        <button class="tab-btn" id="btn-contact" onclick="showTab('contact')">Contact Details</button>
        <button class="tab-btn" id="btn-docs" onclick="showTab('documents')">Documents</button>
    </div>

    <div id="browse-section">
         <div class="category-nav">
            <button class="cat-filter-btn active" onclick="filterCat('All', this)">All</button>
            <button class="cat-filter-btn" onclick="filterCat('Signature', this)">Signature</button>
            <button class="cat-filter-btn" onclick="filterCat('Espresso Based', this)">Espresso</button>
            <button class="cat-filter-btn" onclick="filterCat('Milk Based', this)">Milk Based</button>
            <button class="cat-filter-btn" onclick="filterCat('Frappe', this)">Frappe</button>
            <button class="cat-filter-btn" onclick="filterCat('NA', this)">NA</button>
            <button class="cat-filter-btn" onclick="filterCat('Mojito', this)">Mojito</button>
            <button class="cat-filter-btn" onclick="filterCat('Matcha', this)">Matcha</button>
            <button class="cat-filter-btn" onclick="filterCat('Fruit & Smoothies', this)">Fruit & Smoothies</button>
            <button class="cat-filter-btn" onclick="filterCat('Pour Over', this)">Pour Over</button>
            <button class="cat-filter-btn" onclick="filterCat('Batch', this)">Batch</button>
            <button class="cat-filter-btn" onclick="filterCat('Tea', this)">Tea</button>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-bar" placeholder="Search by drink name..." onkeyup="renderCards()">
        </div>
        <div class="recipe-grid" id="recipeGrid"></div>
    </div>

    <div id="quiz-section">
        <div class="quiz-box">
            <span class="cat-tag" id="q-cat" style="background: var(--accent);">Category</span>
            <div class="question-text" id="q-text">Which ingredients belong to this drink?</div>
            <div class="options-grid" id="q-options"></div>
        </div>
    </div>

    <div id="calc-section">
        <div class="calc-box">
            <h2 style="color:var(--accent); text-transform:uppercase; letter-spacing:2px; margin-bottom:30px;">Yield Calculator</h2>
            <div class="category-nav" style="border:none;">
                <button class="cat-filter-btn active" onclick="setCalcDevice('Espresso', 2, this)">Espresso (1:2)</button>
                <button class="cat-filter-btn" onclick="setCalcDevice('V60', 15, this)">V60 (1:15)</button>
                <button class="cat-filter-btn" onclick="setCalcDevice('Chemex', 15, this)">Chemex (1:15)</button>
                <button class="cat-filter-btn" onclick="setCalcDevice('Aeropress', 10, this)">Aeropress (1:10)</button>
            </div>
            <label class="label">Enter Coffee Dose (Grams)</label>
            <input type="number" id="calcDose" class="calc-input" placeholder="0" oninput="calculateYield()">
            <div class="yield-display">
                <span class="label">Target Yield (Output)</span>
                <span class="yield-value"><span id="yieldResult">0</span>g</span>
            </div>
        </div>
    </div>

    <div id="dial-section">
        <div class="calc-box" style="text-align: left;">
            <h2 style="color:var(--accent); text-transform:uppercase; letter-spacing:2px; margin-bottom:10px; text-align:center;">Espresso Compass</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div><span class="label">Dose (g)</span><input type="number" id="dialDose" class="calc-input" placeholder="18.0" step="0.1"></div>
                <div><span class="label">Yield (g)</span><input type="number" id="dialYield" class="calc-input" placeholder="36.0" step="0.1"></div>
                <div><span class="label">Time (sec)</span><input type="number" id="dialTime" class="calc-input" placeholder="28"></div>
            </div>
            <span class="label">Flavor Note</span>
            <select id="dialFlavor" class="calc-input">
                <option value="">-- Select Flavor Profile --</option>
                <option value="under">Intense Sour / Salty / Sharp</option>
                <option value="over">Bitter / Dry / Burnt / Empty</option>
                <option value="sweet">Sweet / Balanced / Tasty</option>
                <option value="uneven">Both Bitterness and Sourness</option>
            </select>
            <button class="tab-btn active" style="width: 100%; margin-top: 20px;" onclick="runCalibration()">Analyze Shot</button>
            <div id="dialResult" class="yield-display" style="display:none;">
                <span class="label">Recommendation</span>
                <div id="dialMessage" class="content" style="color: white; margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <div id="trouble-section">
        <div class="calc-box">
            <h2 style="color:var(--accent); text-transform:uppercase; letter-spacing:2px; margin-bottom:30px;">Troubleshooting</h2>
            <div class="category-nav" style="border:none;">
                <button class="cat-filter-btn active" onclick="filterTrouble('Grinders', this)">Grinder</button>
                <button class="cat-filter-btn" onclick="filterTrouble('Espresso Machines', this)">Espresso Machine</button>
                <button class="cat-filter-btn" onclick="filterTrouble('Boilers', this)">Boiler</button>
                <button class="cat-filter-btn" onclick="filterTrouble('Milk', this)">Milk</button>
                <button class="cat-filter-btn" onclick="filterTrouble('Drinks', this)">Drinks</button>
            </div>
            <label class="label">Identify the issue:</label>
            <select id="troubleSelect" class="calc-input" onchange="handleTroubleSelection(this)" style="text-align: left;">
                <option value="">-- Select an Issue --</option>
            </select>
        </div>
    </div>

    <div id="contact-section" style="display:none;"><div class="recipe-grid" id="contactGrid"></div></div>
    <div id="documents-section" style="display:none;"><div class="recipe-grid" id="docsGrid"></div></div>
</div>

<div id="popup-overlay">
    <div class="popup-box">
        <h2 id="popup-title" style="color:var(--error); margin-top:0; letter-spacing:2px;">NOTICE</h2>
        <p id="popup-desc"></p>
        <div style="text-align: left; background: #f9f9f9; padding: 20px; border-radius: 4px; border-left: 4px solid var(--accent); margin: 20px 0;">
            <span class="label" id="label-1">Info</span><div id="p-ing" class="content"></div>
            <span class="label" id="label-2">Details</span><div id="p-meth" class="content"></div>
            <span class="label" id="label-3">Reference</span><div id="p-eq" class="content"></div>
            <span class="label" id="label-4" style="display:none;">Serving</span><div id="p-serv" class="content"></div>
        </div>
        <button class="tab-btn active" style="width: 100%;" onclick="closePopup()">I Understand</button>
    </div>
</div>

<div id="pdf-overlay">
    <div class="pdf-header">
        <span style="color:var(--accent); font-weight:bold; letter-spacing:2px;">STAFF DOCUMENT</span>
        <button onclick="closePDF()" style="background:var(--error); color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">CLOSE</button>
    </div>
    <iframe id="pdf-frame" src="" style="width:100%; height:100%; border:none;"></iframe>
</div>

<script>
const MASTER_PASS = "Refill2024";
let data = [];
let currentRatio = 2;
let activeCat = "All";
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ13wVqduebIg7mNo0ppS0BGucdTT8rviaMw6-FZcATLyJ11aBE8809JXrTzzQlsjAPuyJTy0R1H9qg/pub?gid=0&single=true&output=csv";

// TROUBLESHOOTING DATABASE
const troubleDB = [
    { cat: "Grinders", issue: "Grinder blocked (motor sounds turning)", diag: "Hopper gate closed, grind setting too fine, or oily roast.", treat: "Close hopper gate, remove hopper, and vacuum out retained grinds." },
    { cat: "Grinders", issue: "Grinder blocked (motor not turning)", diag: "Jamming caused by fine grinds or oily beans; potential blown capacitor.", treat: "Remove all grinds. If blades won't spin after clearing, seek trained help." },
    { cat: "Grinders", issue: "Grinder not switching on", diag: "Hopper safety switch not engaged or a tripped circuit breaker.", treat: "Ensure hopper is seated correctly. Check external circuit breaker (e.g. EK43)." },
    { cat: "Espresso Machines", issue: "Cannot get portafilter into group head", diag: "Basket not horizontal, residue buildup, or overdosing.", treat: "Clean shower screen/gasket. Level the basket and check dose with scales." },
    { cat: "Espresso Machines", issue: "Group head leaking during shot", diag: "Worn gasket, residue on gasket, or handle not pushed far enough.", treat: "Clean gasket. Replace gaskets twice a year." },
    { cat: "Boilers", issue: "Steam wand aggressive / Milk spills", diag: "Boiler pressure > 1.3 bars or large holes in tip.", treat: "Consult qualified technician. Use a larger pitcher." },
    { cat: "Milk", issue: "Foam breaking up immediately", diag: "Sour milk or UV light damage.", treat: "Do not store milk in direct sunlight. Note: Sour milk cannot hold foam." },
    { cat: "Drinks", issue: "Drinks are too cold", diag: "Temp below 55C, unheated cups, or cups stacked too high.", treat: "Stack cups max 3 high. Use thermometer to verify standards." }
];

async function fetchRecipes() {
    try {
        const response = await fetch(SHEET_URL);
        const csvText = await response.text();
        const rows = csvText.split('\n').slice(1);
        data = rows.map(row => {
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return {
                name: cols[0]?.replace(/"/g, ''),
                cat: cols[1]?.replace(/"/g, ''),
                color: cols[2]?.replace(/"/g, '') || "var(--accent)",
                ing: cols[3]?.replace(/"/g, ''),
                method: cols[4]?.replace(/"/g, ''),
                eq: cols[5]?.replace(/"/g, ''),
                serv: cols[6]?.replace(/"/g, '')
            };
        }).filter(item => item.name);
        renderCards();
    } catch (e) { console.error("Data load failed", e); }
}

function checkAuth() {
    if(document.getElementById('passInput').value === MASTER_PASS) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        fetchRecipes();
    } else { alert("Incorrect password."); }
}

function showTab(view) {
    const tabs = ['browse', 'quiz', 'calc', 'dial', 'trouble', 'contact', 'documents'];
    tabs.forEach(t => {
        document.getElementById(t + '-section').style.display = (view === t) ? 'block' : 'none';
        const btn = document.getElementById('btn-' + (t === 'documents' ? 'docs' : t));
        if(btn) btn.classList.toggle('active', view === t);
    });
    if(view === 'quiz') startNewQuestion();
    if(view === 'contact') renderContacts();
    if(view === 'documents') renderDocuments();
    if(view === 'trouble') filterTrouble('Grinders', document.querySelector('#trouble-section .cat-filter-btn.active'));
}

// TROUBLESHOOTING LOGIC
function filterTrouble(category, btn) {
    const parent = btn.parentElement;
    parent.querySelectorAll('.cat-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const selector = document.getElementById('troubleSelect');
    selector.innerHTML = '<option value="">-- Select an Issue --</option>';
    troubleDB.filter(t => t.cat === category).forEach(t => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(t);
        opt.innerText = t.issue;
        selector.appendChild(opt);
    });
}

function handleTroubleSelection(select) {
    if(!select.value) return;
    const item = JSON.parse(select.value);
    document.getElementById('popup-title').innerText = "POSSIBLE DIAGNOSIS";
    document.getElementById('popup-title').style.color = "var(--accent)";
    document.getElementById('popup-desc').innerHTML = `Issue: <strong>${item.issue}</strong>`;
    document.getElementById('label-1').innerText = "DIAGNOSIS";
    document.getElementById('p-ing').innerText = item.diag;
    document.getElementById('label-2').innerText = "TREATMENT";
    document.getElementById('p-meth').innerText = item.treat;
    document.getElementById('label-3').innerText = "CATEGORY";
    document.getElementById('p-eq').innerText = item.cat;
    document.getElementById('label-4').style.display = 'none';
    document.getElementById('popup-overlay').style.display = 'flex';
}

// CALCULATOR LOGIC
function setCalcDevice(dev, ratio, btn) {
    currentRatio = ratio;
    btn.parentElement.querySelectorAll('.cat-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    calculateYield();
}
function calculateYield() {
    const dose = document.getElementById('calcDose').value;
    document.getElementById('yieldResult').innerText = dose > 0 ? (dose * currentRatio).toFixed(1) : "0";
}

// CALIBRATION LOGIC
function runCalibration() {
    const flavor = document.getElementById('dialFlavor').value;
    if(!flavor) return;
    const msg = document.getElementById('dialMessage');
    document.getElementById('dialResult').style.display = 'block';
    if(flavor === "under") msg.innerHTML = "<strong>Under-extracted:</strong> Grind finer OR increase yield.";
    else if(flavor === "over") msg.innerHTML = "<strong>Over-extracted:</strong> Grind coarser OR decrease yield.";
    else if(flavor === "sweet") msg.innerHTML = "<strong>Perfect Shot:</strong> Sweet spot achieved.";
    else msg.innerHTML = "<strong>Uneven Extraction:</strong> Likely channeling. Check distribution.";
}

// SHARED FUNCTIONS
function closePopup() { 
    document.getElementById('popup-overlay').style.display = 'none'; 
    if(document.getElementById('quiz-section').style.display === 'block') startNewQuestion();
}
function filterCat(cat, btn) { activeCat = cat; btn.parentElement.querySelectorAll('.cat-filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderCards(); }
function renderCards() {
    const grid = document.getElementById('recipeGrid');
    const q = document.getElementById('searchInput').value.toLowerCase();
    grid.innerHTML = '';
    data.filter(r => (activeCat === "All" || r.cat === activeCat) && r.name.toLowerCase().includes(q)).forEach(r => {
        const div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => div.classList.toggle('flipped');
        div.innerHTML = `<div class="card-inner"><div class="card-front"><span class="cat-tag" style="background:${r.color}">${r.cat}</span><h2>${r.name}</h2></div><div class="card-back"><span class="label">Ingredients</span><div class="content">${r.ing}</div><span class="label">Method</span><div class="content">${r.method}</div></div></div>`;
        grid.appendChild(div);
    });
}
function startNewQuestion() {
    if(!data.length) return;
    const q = data[Math.floor(Math.random() * data.length)];
    document.getElementById('q-cat').innerText = q.cat;
    document.getElementById('q-text').innerText = `Ingredients for: ${q.name}`;
    const opts = [q.ing];
    while(opts.length < 4) { let r = data[Math.floor(Math.random() * data.length)].ing; if(!opts.includes(r)) opts.push(r); }
    opts.sort(() => Math.random() - 0.5);
    const container = document.getElementById('q-options');
    container.innerHTML = '';
    opts.forEach(opt => {
        const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = opt;
        b.onclick = () => { if(opt === q.ing) startNewQuestion(); else showQuizPopup(q); };
        container.appendChild(b);
    });
}
function showQuizPopup(q) {
    document.getElementById('popup-title').innerText = "INCORRECT";
    document.getElementById('p-ing').innerText = q.ing;
    document.getElementById('p-meth').innerText = q.method;
    document.getElementById('label-4').style.display = 'block';
    document.getElementById('p-serv').innerText = q.serv;
    document.getElementById('popup-overlay').style.display = 'flex';
}
</script>
</body>
</html>